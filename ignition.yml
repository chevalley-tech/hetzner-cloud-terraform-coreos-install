# This config is meant to be consumed by the config transpiler, which will
# generate the corresponding Ignition config. Do not pass this config directly
# to instances of Container Linux.

# NOTE: This configuration is meant to work with Config Transpiler v0.8.0
# The spec is available at (https://github.com/coreos/container-linux-config-transpiler/blob/v0.8.0/doc/configuration.md)

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDy+Gfzd3XdOQ+DGI+kugkQsrtploaLwxkCx3aLyoIqbgYuvuHxcAH3P3X43w86zmlatfkj09n62E3ZGADqUjEn9KZTlWcHyPTEb4/vjPFrVbndSbflQy9RZ2bU6nwouBNPZ9alYkK30caLS+IPA0Srqubct0rUrVxRLk6j/HD3mgtgOP3nJML86A6EnXQprfTlF86Yc4WgN1fmnM97vRxrWGiH/RbIjp8Tv0eqMuf6J/M+iWq6GqaoqCORtr01NYsVka40Ac/w0o5arA37xkk6gQy8w5ZMkhvDjfpxusLRMkB8siiOZM/D0UHeBZyJB2/2PMiqbBZg4FkBJ6DlvxdN0wnsTZwzp0eYlbKOrNZ9orUP0Pxq8UTA9pQiYsfleYbnm5fDrbmyvT0cgt6pSeCwsoA2CHAjoWrE6wvVW4lZLrZBHr0qgXy0RCFln7k9R4UTtDAsdDUjcCbtgyl6XycMj8SuW0g/rIbYn6++W1rmo6ScS4HX7KZ0xkQEfN3DO1CJOiOqNTJaK44ZYILoNtf4rpqzg/1G7WFSuOt93yV7INQSmuKclcagvWILkmucNRk2RAo9Sch3UU4f6KtvasTdTaz5yY9lrQ0hssIN5a0bZOxo6ZQRMiyam9vojQxOfb8Xxq1BXunFTJKIAfzLf9hfTPMDzldUbaUVn55rh43qPQ== gregory.chevalley+x200t@gmail.com

systemd:
  units:
    - name: docker.service
      enabled: true

    - name: k8s-install.service
      enabled: true
      contents: |
        [Install]
        WantedBy=multi-user.target

        [Unit]
        Description=k8s installation script
        Wants=network-online.target
        After=network.target network-online.target

        [Service]
        Type=oneshot
        ExecStart=/ignition/init/k8s/install.sh

    - name: cri-tools-install.service
      enabled: true
      contents: |
        [Install]
        WantedBy=multi-user.target

        [Unit]
        Description=cri-tools installation script
        Requires=k8s-install.service
        After=k8s-install.service

        [Service]
        Type=oneshot
        ExecStart=/ignition/init/cri-tools/install.sh

    - name: cni-install.service
      enabled: true
      contents: |
        [Install]
        WantedBy=multi-user.target

        [Unit]
        Description=cni plugin installation script
        Requires=k8s-install.service
        After=k8s-install.service

        [Service]
        Type=oneshot
        ExecStart=/ignition/init/cni/install.sh

storage:
  files:
    - path: /opt/bin/kubeadm
      filesystem: root
      mode: 493 # 0755
      contents:
        remote:
          url: https://storage.googleapis.com/kubernetes-release/release/v1.11.0/bin/linux/amd64/kubeadm

    - path: /opt/bin/kubelet
      filesystem: root
      mode: 493 # 0755
      contents:
        remote:
          url: https://storage.googleapis.com/kubernetes-release/release/v1.11.0/bin/linux/amd64/kubelet

    - path: /opt/bin/kubectl
      filesystem: root
      mode: 511 # 0777
      contents:
        remote:
          url: https://storage.googleapis.com/kubernetes-release/release/v1.11.0/bin/linux/amd64/kubectl

    - path: /etc/systemd/system/kubelet.service
      filesystem: root
      mode: 420 # 0644
      contents:
        remote:
          url: https://raw.githubusercontent.com/kubernetes/kubernetes/v1.11.0/build/debs/kubelet.service

    - path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
      filesystem: root
      mode: 420 # 0644
      contents:
        remote:
          url: https://raw.githubusercontent.com/kubernetes/kubernetes/v1.11.0/build/debs/10-kubeadm.conf

    - path: /ignition/init/cni/cni-plugins-v0.7.1.tgz
      filesystem: root
      mode: 420 # 0644
      contents:
        remote:
          url: https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz
          verification:
            hash:
              function: sha512
              sum: b3b0c1cc7b65cea619bddae4c17b8b488e7e13796345c7f75e069af93d1146b90a66322be6334c4c107e8a0ccd7c6d0b859a44a6745f9b85a0239d1be9ad4ccd

    - path: /ignition/init/cri-tools/crictl-v1.11.0-linux-amd64.tar.gz
      filesystem: root
      mode: 420 # 0644
      contents:
        remote:
          url: https://github.com/kubernetes-incubator/cri-tools/releases/download/v1.11.0/crictl-v1.11.0-linux-amd64.tar.gz

    - path: /ignition/init/k8s/install.sh
      filesystem: root
      mode: 480 # 740
      contents:
        inline: |
          #!/bin/bash

          # Unzip the kubernetes binaries if not already present
          test -d /opt/bin/kubeadm && echo "k8s binaries (kubeadm) already installed" && exit 0

          # NOTE: If RELEASE is updated, the SHA512 SUMs will need to be as well
          VERSION=v1.11.0
          echo -e "=> Installing k8s (v${VERSION})"

          mkdir -p /var/lib/kubelet/volumeplugins
          mkdir -p /var/lib/rook

          echo "=> Adding dropins...."
          cat > /etc/systemd/system/kubelet.service.d/0-rook.conf <<EOF
          [Service]
          Environment="KUBELET_EXTRA_ARGS=--volume-plugin-dir=/var/lib/kubelet/volumeplugins"
          EOF

          echo "=> Cusomizing kubelet.service..."
          sed -i "s:/usr/bin:/opt/bin:g" /etc/systemd/system/kubelet.service
          sed -i "s:/usr/bin:/opt/bin:g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

          systemctl daemon-reload
          systemctl enable kubelet
          systemctl start kubelet

    - filesystem: root
      path: /ignition/init/cni/install.sh
      mode: 480 # 740
      contents:
        inline: |
          #!/bin/bash

          # Unzip the kubernetes binaries if not already present
          test -d /opt/cni/bin && echo "CNI binaries already installed" && exit 0

          VERSION=0.7.1
          echo -e "=> Installing CNI (v${VERSION}) binaries to /opt/cni/bin"
          cd /ignition/init/cni
          mkdir -p /opt/cni/bin
          tar -C /opt/cni/bin -k -xzf cni-plugins-v${VERSION}.tgz

    - filesystem: root
      path: /ignition/init/cri-tools/install.sh
      mode: 480 # 740
      contents:
        inline: |
          #!/bin/bash

          cd /ignition/init/cri-tools
          tar -C /opt/bin -k -xzf crictl-v1.11.0-linux-amd64.tar.gz
